---
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |
      kubectl apply -n $NAMESPACE -f - <<EOF
      ---
      apiVersion: zookeeper.stackable.tech/v1alpha1
      kind: ZookeeperZnode
      metadata:
        name: hbase-znode
      spec:
        clusterRef:
          name: zookeeper
      ---
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: hbase-log-config
      data:
        log4j.properties: |
          # Define loggers
          log4j.rootLogger=INFO, FILE
          log4j.logger.tech.stackable.hbase=DEBUG, CONSOLE
          # Define file appender
          log4j.appender.FILE=org.apache.log4j.FileAppender
          log4j.appender.FILE.File=/stackable/log/hbase/hbase.log4j.xml
          log4j.appender.FILE.layout=org.apache.log4j.xml.XMLLayout
          # Define console appender
          log4j.appender.CONSOLE=org.apache.log4j.ConsoleAppender
          log4j.appender.CONSOLE.Target=System.out
          log4j.appender.CONSOLE.layout=org.apache.log4j.PatternLayout
          log4j.appender.CONSOLE.layout.ConversionPattern=%-5p %c{1} - %m%n
      ---
      apiVersion: hbase.stackable.tech/v1alpha1
      kind: HbaseCluster
      metadata:
        name: hbase
      spec:
        image:
{% if test_scenario['values']['hbase'].find(",") > 0 %}
          custom: "{{ test_scenario['values']['hbase'].split(',')[1] }}"
          productVersion: "{{ test_scenario['values']['hbase'].split(',')[0] }}"
{% else %}
          productVersion: "{{ test_scenario['values']['hbase'] }}"
{% endif %}
          pullPolicy: IfNotPresent
        clusterConfig:
          hdfsConfigMapName: hdfs
          zookeeperConfigMapName: hbase-znode
          listenerClass: {{ test_scenario['values']['listener-class'] }}
          authentication:
            tlsSecretClass: tls
            kerberos:
              secretClass: kerberos-$NAMESPACE
{% if lookup('env', 'VECTOR_AGGREGATOR') %}
          vectorAggregatorConfigMapName: vector-aggregator-discovery
{% endif %}
        masters:
          configOverrides: &configOverrides
            hbase-site.xml:
              hbase.security.authorization: "true"
              hbase.coprocessor.region.classes: tech.stackable.hbase.AllowAccessController
              hbase.coprocessor.master.classes: tech.stackable.hbase.AllowAccessController
              hbase.coprocessor.regionserver.classes: tech.stackable.hbase.AllowAccessController
              hbase.security.exec.permission.checks: "true"
          config:
            logging:
              enableVectorAgent: {{ lookup('env', 'VECTOR_AGGREGATOR') | length > 0 }}
          roleGroups:
            default:
              replicas: 2
              config:
                logging:
                  enableVectorAgent: false
                  containers:
                    hbase:
                      custom:
                        configMap: hbase-log-config
        regionServers:
          configOverrides: *configOverrides
          config:
            logging:
              enableVectorAgent: {{ lookup('env', 'VECTOR_AGGREGATOR') | length > 0 }}
          roleGroups:
            default:
              replicas: 2
              config:
                logging:
                  enableVectorAgent: false
                  containers:
                    hbase:
                      custom:
                        configMap: hbase-log-config
        restServers:
          configOverrides: *configOverrides
          config:
            logging:
              enableVectorAgent: {{ lookup('env', 'VECTOR_AGGREGATOR') | length > 0 }}
          roleGroups:
            default:
              replicas: 1
              config:
                logging:
                  enableVectorAgent: false
                  containers:
                    hbase:
                      custom:
                        configMap: hbase-log-config
      EOF
