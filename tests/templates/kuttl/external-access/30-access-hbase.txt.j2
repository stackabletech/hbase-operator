---
apiVersion: batch/v1
kind: Job
metadata:
  name: access-hbase
spec:
  template:
    spec:
      serviceAccountName: test-sa
      containers:
        - name: access-hbase
{% if test_scenario['values']['hbase'].find(",") > 0 %}
          image: "{{ test_scenario['values']['hbase'].split(',')[1] }}"
{% else %}
          image: oci.stackable.tech/sdp/hbase:{{ test_scenario['values']['hbase'] }}-stackable0.0.0-dev
{% endif %}
          imagePullPolicy: IfNotPresent
          command:
            - /bin/bash
            - /tmp/script/script.sh
          env:
            - name: MASTER_UI
              valueFrom:
                configMapKeyRef:
                  name: test-hbase-ui-endpoints
                  key: hbase.master.ui
            - name: REGIONSERVER_UI
              valueFrom:
                configMapKeyRef:
                  name: test-hbase-ui-endpoints
                  key: hbase.regionserver.ui
            - name: RESTSERVER_UI
              valueFrom:
                configMapKeyRef:
                  name: test-hbase-ui-endpoints
                  key: hbase.restserver.ui
          volumeMounts:
            - name: script
              mountPath: /tmp/script
      volumes:
        - name: script
          configMap:
            name: access-hbase-script
      securityContext:
        fsGroup: 1000
        runAsGroup: 1000
        runAsUser: 1000
      restartPolicy: OnFailure
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: access-hbase-script
data:
  script.sh: |
    set -euxo pipefail

    echo "Attempting to reach master at $MASTER_UI..."
    curl --retry 0 -f -s -o /dev/null -w "%{http_code}" $MASTER_UI | grep 200
    echo "Attempting to reach region-server at $REGIONSERVER_UI..."
    curl --retry 0 -f -s -o /dev/null -w "%{http_code}" $REGIONSERVER_UI | grep 200
    echo "Attempting to reach rest-server at $RESTSERVER_UI..."
    curl --retry 0 -f -s -o /dev/null -w "%{http_code}" $RESTSERVER_UI | grep 200

    echo "All tests successful!"
